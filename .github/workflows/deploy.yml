name: deploy

on:
  workflow_run:
    workflows: ["ci"]
    types: [completed]
  workflow_dispatch:
    inputs:
      force_install:
        description: "Run deploy/install.sh instead of deploy/upgrade.sh"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

concurrency:
  group: nebula-production-deploy
  cancel-in-progress: true

jobs:
  deploy:
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push' &&
       github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Resolve ref
        id: ref
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_run" ]]; then
            echo "sha=${{ github.event.workflow_run.head_sha }}" >> "${GITHUB_OUTPUT}"
          else
            echo "sha=${GITHUB_SHA}" >> "${GITHUB_OUTPUT}"
          fi

      - name: Validate deploy secrets
        id: validate
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          set -euo pipefail
          missing=()
          [[ -n "${VPS_HOST}" ]] || missing+=("VPS_HOST")
          [[ -n "${VPS_USER}" ]] || missing+=("VPS_USER")
          [[ -n "${VPS_SSH_KEY}" ]] || missing+=("VPS_SSH_KEY")

          if (( ${#missing[@]} > 0 )); then
            joined="$(IFS=,; echo "${missing[*]}")"
            echo "ready=false" >> "${GITHUB_OUTPUT}"
            echo "missing=${joined}" >> "${GITHUB_OUTPUT}"

            if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
              echo "::error::Missing required repo secrets: ${joined}"
              echo "Add secrets in Settings -> Secrets and variables -> Actions."
              exit 1
            fi

            echo "::notice::Skipping deploy because required secrets are missing: ${joined}"
            exit 0
          fi

          echo "ready=true" >> "${GITHUB_OUTPUT}"

      - name: Checkout
        if: steps.validate.outputs.ready == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.ref.outputs.sha }}

      - name: Set up Go
        if: steps.validate.outputs.ready == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build Linux binaries
        if: steps.validate.outputs.ready == 'true'
        env:
          TARGET_GOARCH: ${{ secrets.VPS_GOARCH }}
        run: |
          set -euo pipefail
          GOARCH="${TARGET_GOARCH:-amd64}"
          CGO_ENABLED=0 GOOS=linux GOARCH="${GOARCH}" go build -o bin/nebula-api ./apps/api/cmd/api
          CGO_ENABLED=0 GOOS=linux GOARCH="${GOARCH}" go build -o bin/nebula-agent ./apps/agent/cmd/agent
          CGO_ENABLED=0 GOOS=linux GOARCH="${GOARCH}" go build -o bin/nebula-worker ./apps/worker/cmd/worker

      - name: Prepare release archive
        if: steps.validate.outputs.ready == 'true'
        run: |
          set -euo pipefail
          tar \
            --exclude-vcs \
            --exclude='apps/web/node_modules' \
            --exclude='apps/web/.next' \
            -czf nebula-release.tgz .

      - name: Configure SSH
        if: steps.validate.outputs.ready == 'true'
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          set -euo pipefail
          PORT="${VPS_PORT:-22}"

          mkdir -p "${HOME}/.ssh"
          chmod 700 "${HOME}/.ssh"
          printf '%s' "${VPS_SSH_KEY}" > "${HOME}/.ssh/id_ed25519"
          chmod 600 "${HOME}/.ssh/id_ed25519"
          ssh-keyscan -p "${PORT}" -H "${VPS_HOST}" >> "${HOME}/.ssh/known_hosts"
          chmod 600 "${HOME}/.ssh/known_hosts"

      - name: Upload release
        if: steps.validate.outputs.ready == 'true'
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          set -euo pipefail
          PORT="${VPS_PORT:-22}"
          scp -P "${PORT}" nebula-release.tgz "${VPS_USER}@${VPS_HOST}:/tmp/nebula-release.tgz"

      - name: Deploy on server
        if: steps.validate.outputs.ready == 'true'
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_DEPLOY_DIR: ${{ secrets.VPS_DEPLOY_DIR }}
          FORCE_INSTALL: ${{ github.event.inputs.force_install || 'false' }}
        run: |
          set -euo pipefail
          PORT="${VPS_PORT:-22}"
          DEPLOY_DIR="${VPS_DEPLOY_DIR:-/opt/src/Nebula}"

          ssh -p "${PORT}" "${VPS_USER}@${VPS_HOST}" "DEPLOY_DIR='${DEPLOY_DIR}' FORCE_INSTALL='${FORCE_INSTALL}' bash -s" <<'EOSSH'
          set -euo pipefail

          run_root() {
            if command -v sudo >/dev/null 2>&1; then
              sudo "$@"
            else
              "$@"
            fi
          }

          DEPLOY_DIR="${DEPLOY_DIR:-/opt/src/Nebula}"
          FORCE_INSTALL="${FORCE_INSTALL:-false}"

          if [[ -z "${DEPLOY_DIR}" || "${DEPLOY_DIR}" == "/" ]]; then
            echo "Invalid DEPLOY_DIR: ${DEPLOY_DIR}"
            exit 1
          fi

          run_root mkdir -p "${DEPLOY_DIR}"
          run_root tar -xzf /tmp/nebula-release.tgz -C "${DEPLOY_DIR}"
          rm -f /tmp/nebula-release.tgz

          cd "${DEPLOY_DIR}"
          if [[ "${FORCE_INSTALL}" == "true" ]]; then
            run_root bash deploy/install.sh
          elif [[ -f /etc/nebula-panel/secrets.env ]]; then
            run_root bash deploy/upgrade.sh
          else
            run_root bash deploy/install.sh
          fi

          if command -v systemctl >/dev/null 2>&1; then
            run_root systemctl is-active nebula-agent nebula-api nebula-worker nebula-web
          fi
          EOSSH
